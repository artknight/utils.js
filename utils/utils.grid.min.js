UTILS.Grid=class extends UTILS.Base{constructor(data={}){return super(data),_log(this.getObjectName()+" --\x3e instantiated!",this.getId(),this),"items"in data&&this.setItems(data.items),"width"in data&&this.setGridWidth(data.width),"onChange"in data&&this.addCallback("onChange",data.onChange),"onStateChange"in data&&this.addCallback("onStateChange",data.onStateChange),"onShow"in data&&this.addCallback("onShow",data.onShow),"onRenderedGridForPresentation"in data&&this.addCallback("onRenderedGridForPresentation",data.onRenderedGridForPresentation),"onEnableEditing"in data&&this.addCallback("onEnableEditing",data.onEnableEditing),"onDisableEditing"in data&&this.addCallback("onDisableEditing",data.onDisableEditing),"presentation"in data&&data.presentation&&this.setPresentationMode(data.presentation),"collapse"in data&&data.collapse&&this.enableCollapse(),this}getDefaults(){return{object:"utils.grid",version:"1.2.0",Grid:null,$items:[],$target:$("body"),grid_width:12,grid_cell_height:80,is_presentation:!1,is_collapse:!1,divs:{$grid:null,cells:[]},default_gridfield_data:{x:0,y:0,width:1,height:1,min_width:1,min_height:1}}}isCollapsable(){return this.values.is_collapse}enableCollapse(){return _log(this.getObjectName()+" --\x3e collapse setting enabled",this.getId()),this.values.is_collapse=!0,this}disableCollapse(){return _log(this.getObjectName()+" --\x3e collapse setting disabled",this.getId()),this.values.is_collapse=!1,this}isPresentationMode(){return this.values.is_presentation}setPresentationMode(state){return _log(this.getObjectName()+" --\x3e mode changed to "+(state?"presentation":"editable"),this.getId()),this.values.is_presentation=state,this}_getGridCellHeight(){return this.values.grid_cell_height}_setGridCellHeight(height){return _log(this.getObjectName()+" --\x3e cell height changed to "+height,this.getId()),this.values.grid_cell_height=height,this}getGridWidth(){return this.values.grid_width}setGridWidth(width){this.values.grid_width=width;var $grid=this.getGrid(),gridElm=this.getGridElm(),classes=$grid.attr("class").match(/(?:^|)grid-stack-(\w+)(?!\w)/g)||[];return classes.length&&$grid.removeClass(_.joinArray(classes," ")),$grid.addClass("grid-stack-"+width).attr("data-gs-width",width),gridElm&&gridElm.setGridWidth(width),_log(this.getObjectName()+" --\x3e width changed to "+width,this.getId()),this}getGridHeight(){return Math.max.apply(null,_.map(this.getItems(),function(item){var data=$(item).data("grid");return data.y+data.width}))}getItems(){return this.values.$items}_getNextDefaultFieldValueByType(type,count){var default_value=this.values.default_gridfield_data[type];return/x/.test(type)?default_value=count%12:/y/.test(type)&&(default_value=Math.floor(count/12)),default_value}setItems(items=[]){if(items.length){var _items=_.map(items,function(item,i){var $item;return item instanceof jQuery?$item=$(item):($item=$('<div class="grid-field"></div>'),"content"in item&&$item.html(item.content),$item.data("grid",{x:"x"in item?item.x:this._getNextDefaultFieldValueByType("x"),y:"y"in item?item.y:this._getNextDefaultFieldValueByType("y"),height:"height"in item?item.height:this._getNextDefaultFieldValueByType("height"),width:"width"in item?item.width:this._getNextDefaultFieldValueByType("width"),min_width:"min_width"in item?item.min_width:this._getNextDefaultFieldValueByType("min_width"),min_height:"min_height"in item?item.min_height:this._getNextDefaultFieldValueByType("min_height")})),$item.addClass("grid-field"),$item}.bind(this));this.values.$items=$(_items);var $tmp_container=$('<div class="hide"></div>');$("body").append($tmp_container),$tmp_container.append(items),this.addCallback("onShow",function(){$tmp_container.remove()})}else UTILS.Errors.show("@items cannot be empty");return this}_getCells(){return this.values.divs.cells}getGrid(){return this.values.divs.$grid}_getGridElm(){return this.values.Grid}_setGridElm(Grid){return this.values.Grid=Grid,this}_createCell($item){var $cell=null,data=$item.data("grid");$cell=$('<div class="grid-stack-item" data-gs-x="'+data.x+'" data-gs-y="'+data.y+'" data-gs-width="'+data.width+'" data-gs-height="'+data.height+'"></div>').append($('<div class="grid-stack-item-content"></div>').append($item));return"min_width"in data&&$cell.attr("data-gs-min-width",data.min_width),"min_height"in data&&$cell.attr("data-gs-min-height",data.min_height),"max_width"in data&&$cell.attr("data-gs-max-width",data.max_width),"max_height"in data&&$cell.attr("data-gs-max-height",data.max_height),$cell}_addCellToGrid($cell){return this.values.divs.cells.push($cell),this.getGrid().append($cell),this}_loadItemsIntoCells(){var items=this.getItems();return items.length&&_.each(items,function(item){var $item=$(item),$cell=this._createCell($item);this._addCellToGrid($cell)}.bind(this)),this}_createGrid(){var items=this.getItems();return this.values.divs.$grid=$('<div class="grid-stack hide '+(this.isPresentationMode()?"grid-presentation":"")+'"></div>').data("app-gridstack",this),this.getTarget().prepend(this.values.divs.$grid),this.isPresentationMode()||(items.length&&this._loadItemsIntoCells(),this._initGridstack()),this.values.divs.$grid}_initGridstack(){var $grid=this.getGrid();return $grid.gridstack({cellHeight:this._getGridCellHeight(),verticalMargin:10,alwaysShowResizeHandle:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),draggable:{scroll:!0},resizable:{handles:"e, se, s, sw, w"}}).on("change",this.onGridChange.bind(this)),this._setGridElm($grid.data("gridstack")),this.fns("onCreate"),this}_unloadGridstack(){var $grid=this.getGrid();return _.each(this.getItems(),function(item){$grid.append($(item))}),$grid.data("gridstack",null),$grid.find(".grid-stack-item").remove(),this}_getCellFromItem($item){return $item.closest(".grid-stack-item")}getNextPosition(width,height,min_width,max_height){var GridElm=this._getGridElm(),$widget=GridElm.addWidget($('<div class="hide"></div>'),0,0,width||1,height||1,!0,min_width||1,null,max_height||1,null),data=this._getCellPosition($widget);return GridElm.removeWidget($widget),{x:data.x,y:data.y,width:data.width,height:data.height,min_width:data.minWidth,min_height:data.minHeight}}showHiddenItem($item){return $item.hasClass("grid-field")||($item=$item.closest(".grid-field")),$item.length&&$item.hasClass("grid-field-hidden")&&(_log(this.getObjectName()+" --\x3e item state changed to show",$item),$item.removeClass("grid-field-hidden"),this.isPresentationMode()?this.reload():(this._getCellFromItem($item).show(),this.isCollapsable()&&this.reload())),this}hideShownItem($item){return $item.hasClass("grid-field")||($item=$item.closest(".grid-field")),$item.length&&!$item.hasClass("grid-field-hidden")&&(_log(this.getObjectName()+" --\x3e item state changed to hide",$item),$item.addClass("grid-field-hidden"),this.isPresentationMode()?this.reload():(this._getCellFromItem($item).hide(),this.isCollapsable()&&this.reload())),this}getCellContent($cell){return $cell.find(".grid-stack-item-content")}_enableEditing(){var GridElm=this._getGridElm();return GridElm&&(GridElm.setStatic(!1),GridElm.cellHeight(this._getGridCellHeight())),this.getGrid().addClass("editable"),this.getTarget().addClass("editable"),this.fns("onEnableEditing"),this}_disableEditing(){var GridElm=this._getGridElm();return GridElm&&(GridElm.setStatic(!0),GridElm.cellHeight(this._getGridCellHeight())),this.getGrid().removeClass("editable"),this.getTarget().removeClass("editable"),this.fns("onDisableEditing"),this}hide(){return this.getGrid().addClass("hide"),this.fns("onHide"),this}show(){return this._createGrid().removeClass("hide"),this.isPresentationMode()?(this._disableEditing(),this._renderGridForPresentation()):this._enableEditing(),this.fns("onShow"),this}reload(){var GridElm=this._getGridElm(),$grid=this.getGrid();_log(this.getObjectName()+" --\x3e reloading...",this.getId());var $tmp_container=$('<div class="hide"></div>');return $("body").append($tmp_container),_.each(this.getItems(),function(item){$tmp_container.append($(item))}),GridElm&&(GridElm.removeAll(),this.values.divs.cells=[]),$grid&&$grid.remove(),this.show(),$tmp_container.remove(),this}onGridChange(){this._udpateItemsPosition().fns("onChange")}_udpateItemsPosition(){return this.isPresentationMode()||_.each(this._getCells(),function($cell){var $item=$cell.find(".grid-field"),item_grid_data=$item.data("grid"),data=this._getCellPosition($cell);$item.data("grid",_.extend(item_grid_data,{x:data.x,y:data.y,width:data.width,height:data.height}))}.bind(this)),this}_getCellPosition($cell){return $cell.data("_gridstack_node")}getItemsAsJSON(){return _.map(this.getItems(),function(field){let $field=$(field),grid_data=$field.data("grid"),origdata=$field.data("origdata")||{};return _.extend({},origdata,grid_data)})}_renderGridForPresentation(){_log(this.getObjectName()+" --\x3e CA --\x3e rendering cells for presentation",this.getId());var $grid=this.getGrid(),items=this.getItems();this.isCollapsable();this._unloadGridstack();var max_width=Math.max.apply(null,_.map(items,function(item){return item.x+item.width}));return 12!==max_width&&($grid[0].style.gridTemplateColumns=`repeat(${max_width},1fr)`),_.each(items,function(item){var $item=$(item),item_data=$item.data("grid"),item_grid_data_col_s=parseInt(item_data.x)+1,item_grid_data_col_e=parseInt(item_data.x)+parseInt(item_data.width)+1,item_grid_data_row_s=parseInt(item_data.y)+1,item_grid_data_row_e=parseInt(item_data.y)+parseInt(item_data.height)+1;$item[0].style.gridColumn=item_grid_data_col_s+"/"+item_grid_data_col_e,$item[0].style.gridRow=item_grid_data_row_s+"/"+item_grid_data_row_e,$item.data("item-data",item),$item.hasClass("grid-field-hidden")&&$item.hide()}),this.fns("onRenderedGridForPresentation"),this}};var GRID=UTILS.Grid;