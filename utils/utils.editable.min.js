UTILS.Editable=class extends UTILS.Base{constructor(data={}){return super(data),"type"in data&&(/^date$/i.test(data.type)?this.values.options={container:this.getContainer(),orientation:"bottom",autoclose:!1,format:"MM/DD/YYYY",startDate:moment().add(1,"day").toDate(),todayHighlight:!0}:/^date\-range$/i.test(data.type)?this.values.options={is_editable_usage:!0,container:this.getContainer(),auto_close:!1,date_format:"MM/DD/YYYY",separator:" - ",start_date:moment().add(1,"day").format("MM/DD/YYYY"),show_topbar:!1,custom_methods_override:[{name:"setTargetValue",method:()=>{}}]}:/^textarea\-wysiwyg/i.test(data.type)?this.values.options={toolbar:[["style",["bold","italic","underline","strikethrough","color","clear"]],["para",["ul","ol"]],["insert",["picture","link","table","hr"]],["code",["gxcode"]],["misc2",["print"]]]}:/^select\-multiselect/i.test(data.type)&&(this.values.options={search_url:null})),this._onSave=_.debounce(this.__onSave__.bind(this),500,{leading:!0}),"params"in data&&this.setParams(data.params),"field"in data&&this.setFieldName(data.field),"type"in data&&this.setType(data.type),"options"in data&&this.setOptions(data.options),"css"in data&&this.setCss(data.css),"filterMethodForEditingValue"in data&&this.setCustomMethodsOverride([{name:"filterValueForEditing",method:data.filterMethodForEditingValue}]),"filterMethodForDisplayValue"in data&&this.setCustomMethodsOverride([{name:"filterValueForDisplay",method:data.filterMethodForDisplayValue}]),"tabbing"in data&&this.setInlineTabbing(data.tabbing),"lazyload"in data&&this.setLazyLoadState(data.lazyload),"contenteditable"in data&&this.setContentEditableState(data.contenteditable),"toggle"in data&&this.setToggleAction(data.toggle),"items"in data&&this.setItems(data.items),"container"in data&&this.setContainer(data.container),"onShow"in data&&this.addCallback("onShow",data.onShow),"onHide"in data&&this.addCallback("onHide",data.onHide),"onCancel"in data&&this.addCallback("onCancel",data.onCancel),"onBeforeSave"in data&&this.addCallback("onBeforeSave",data.onBeforeSave),"onAfterSave"in data&&this.addCallback("onAfterSave",data.onAfterSave),"onSaveError"in data&&this.addCallback("onSaveError",data.onSaveError),"onActionTriggered"in data&&this.addCallback("onActionTriggered",data.onActionTriggered),"onAfterActionTriggered"in data&&this.addCallback("onAfterActionTriggered",data.onAfterActionTriggered),"onNoChange"in data&&this.addCallback("onNoChange",data.onNoChange),"onInputCreate"in data&&this.addCallback("onInputCreate",data.onInputCreate),"value"in data&&this.setValue(data.value),"placeholder"in data&&this.setPlaceholder(data.placeholder),"min_chars"in data&&this.setMinChars(data.min_chars),this}getDefaults(){return{object:"utils.editable",version:"0.8.4",direction:"top",type:{base:"input",option:null},css:"",params:null,$cell:null,$input:null,$container:$("body"),value:null,DatePicker:null,DateRangePicker:null,__selectize:null,__summernote:null,options:{},field_name:"@field",placeholder:"--",is_lazyload:!1,toggle_action:"click",__spinner:new UTILS.Spinner({type:"medium",center:!0,color:"black",blur:!0}),is_inline_tabbing:!1,items:[],is_enabled:!1,is_shown:!1,is_contenteditable:!1,_is_cell_created:null,min_chars:2}}getCss(){return this.values.css}setCss(css){this.values.css=css||""}getMinChars(){return this.values.min_chars}setMinChars(length){this.values.min_chars=length||2}setAjaxData(ajax){return _.isPlainObject(ajax)?super.setAjaxData(ajax):this.values.ajax=null===ajax?{}:ajax,this}getContainer(){return this.values.$container}setContainer(container){return this.values.$container=$(container),this}isLazyLoad(){return this.values.is_lazyload}setLazyLoadState(state){return this.values.is_lazyload=!!state,this}isContentEditable(){return this.values.is_contenteditable}setContentEditableState(state){return(this.isTypeInput()||this.isTypeTextarea())&&(this.values.is_contenteditable=!!state),this}getPlaceholder(value){return _.isFunction(this.values.placeholder)?this.values.placeholder(value,this):this.values.placeholder}setPlaceholder(placeholder){return placeholder&&(this.values.placeholder=placeholder),this}getItems(){return _.clone(this.values.items)}_createOption(item,css){let option;return _.isString(item)?option={label:item,value:item,css:""}:_.isPlainObject(item)&&(option={label:item.label||"",value:item.value||"",css:item.css||""}),css&&(option.css+=" "+css),option}setItems(items){return(_.every(items,elm=>"string"==typeof elm)||_.every(items,elm=>_.isPlainObject(elm)))&&(this.values.items=_.map(items,this._createOption.bind(this))),this}filterValueForEditing(value){var _value=value;return this.getPlaceholder()===_value&&(_value=""),_value}filterValueForDisplay(value){var type=this.getType(),is_multiselect_dropdown=this.isMultiSelect()&&this.isTypeDropDown(),items=this.getItems(),_value=value;if(is_multiselect_dropdown)_value=_.map(value,selected_value=>{let found=_.find(items,item=>item.value==selected_value);return found?found.label:selected_value}).join(", ");else if(/^(select|radio)$/.test(type.base)){var item=_.find(items,item=>item.value==value);item&&(_value=item.label)}return _value.length||(_value=this.getPlaceholder()),_value}_normalizeItemsForDropdown(items){let is_selectize=this.isSelectize(),is_multiselect_dropdown=this.isMultiSelect()&&this.isTypeDropDown();return(is_selectize||is_multiselect_dropdown)&&(items=_.map(items,item=>({text:item.label,value:item.value}))),items}_onItemSearch(query=""){return new Promise((resolve,reject)=>{let $cell=this.getCell(),__spinner=this.getSpinner(),options=this.getOptions(),ajax_options={method:"GET",data:"onBeforeSearch"in options?options.onBeforeSearch.call(null,query.urlEncode(),this):{q:query.urlEncode()}};"method"in options&&(ajax_options.data.method=options.method),"content_type"in options&&(ajax_options.content_type=options.content_type,/\/json$/.test(options.content_type)&&(ajax_options.data=JSON.stringify(ajax_options.data))),__spinner.setTarget($cell).show(),$.fetch(options.search_url,ajax_options).then(response=>{if(__spinner.hide(),_.isString(response)&&(response=JSON.parse(response)),UTILS.Errors.isError(response))reject();else{let items="onAfterSearch"in options?options.onAfterSearch.call(null,response,this):response,new_items=_.uniqBy([...this.getItems(),...items],"value");this.setItems(new_items),_.every(items,item=>"text"in item&&"value"in item)||(items=this._normalizeItemsForDropdown(items)),resolve(items)}}).catch(error=>{__spinner.hide(),error instanceof Error&&UTILS.Errors.show(error.message),reject()})})}_onActionTriggered(){this.values._is_cell_created.then(()=>{let $target=this.getTarget(),$cell=this.getCell(),is_type_input=this.isTypeInput(),is_type_date=this.isTypeDate(),is_type_checkbox=this.isTypeCheckbox(),is_type_radio=this.isTypeRadio(),is_type_dropdown=this.isTypeDropDown(),is_selectize=this.isSelectize(),is_multiselect=this.isMultiSelect(),is_multiselect_dropdown=is_multiselect&&is_type_dropdown,is_wysiwyg=this.isWysiwyg(),is_type_textarea=this.isTypeTextarea(),is_contenteditable=this.isContentEditable(),is_autocomplete=this.isAutoComplete(),$input=this.getInputField(),$next_editable=$target.nextNodeByClass("editable-target"),value=this.getValue(),items=this.getItems(),options=this.getOptions(),is_processing=!1,keys={ENTER:13,ESCAPE:27,TAB:9},active_keys=[keys.ESCAPE],min_chars=this.getMinChars();is_type_textarea||is_multiselect_dropdown||active_keys.push(keys.ENTER);var _triggerNextEditable=()=>{$next_editable.trigger(this.getToggleAction())};if(this.fns("onActionTriggered"),!is_type_date&&!is_type_checkbox){if(is_contenteditable){let prev_value=$input.html().replace(/(<([^>]+)>)/gi,elm=>/\<\/span\>/.test(elm)?", ":"");prev_value===this.getPlaceholder()&&(prev_value=""),$input.data("prev-value",prev_value).prop("contenteditable",!0).text(this.filterValueForEditing(prev_value)).putCursorAtEnd()}if(is_type_input&&is_autocomplete){let autocomplete_options={target:$input,onInput:(Autocomplete,opts)=>{if(opts.query.length>=min_chars)if(options.search_url)this._onItemSearch(opts.query).then(opts.callback);else{let items=_.filter(this.getItems(),item=>item.value.toLowerCase().includes(opts.query.toLowerCase()));opts.callback(items)}},onSelected:(Autocomplete,opts)=>{this._onSave(opts.value),is_processing=!0}};is_multiselect&&(autocomplete_options.multiple=!0),_.extend(autocomplete_options,options),new UTILS.Autocomplete(autocomplete_options)}if($input.on("keydown.utils.editable",event=>{if(!is_autocomplete){let value=$(event.currentTarget)[is_contenteditable?"text":"val"]();active_keys.isIn(UTILS.getCharKey(event))?(event.preventDefault(),this._onSave(value),is_processing=!0):[keys.TAB].isIn(UTILS.getCharKey(event))&&this.isInlineTabbing()&&(event.preventDefault(),is_processing=!0,$next_editable.length?this._onSave(value).then(_triggerNextEditable):this._onSave(value))}}),is_type_dropdown&&items.length&&$input.empty().append(_.map(items,item=>$('<option value="'+item.value+'">'+item.label+"</option>"))),is_type_radio?$input.val([value]):is_contenteditable||$input.val(value),is_selectize||is_multiselect_dropdown){let _onItemSelected=item=>{let value=_.clone(this.getValue());this.isMultiSelect()&&value.push(item),this.setValue(value)},_onItemRemoved=item_value=>{let value=_.clone(this.getValue());this.isMultiSelect()&&_.remove(value,item=>item==item_value),this.setValue(value)},is_last_key_tab=!1,selectize_options={create:!1,selectOnTab:this.isInlineTabbing(),onFocus:event=>{is_processing=!1,this.removeErrorTooltip()},onBlur:event=>{let value=this.getSelectize().getValue();is_processing||(is_last_key_tab&&this.isInlineTabbing()&&$next_editable.length?this._onSave(value).then(_triggerNextEditable):this._onSave(value),is_processing=!0)},onKeyDown:event=>{is_last_key_tab=[keys.TAB].isIn(UTILS.getCharKey(event))}};is_selectize?_.extend(selectize_options,{onChange:()=>{let value=this.getSelectize().getValue();value.length&&(this._onSave(value),is_processing=!0)}}):is_multiselect&&(_.extend(selectize_options,{delimiters:",",plugins:["remove_button"]}),this.getCell().on("keypress.utils.editable",event=>{[keys.ENTER].isIn(UTILS.getCharKey(event))&&event.preventDefault()})),options.search_url&&_.extend(selectize_options,{maxItems:"limit"in options?options.limit:is_multiselect?null:1,onItemRemove:_onItemRemoved,onItemAdd:_onItemSelected,render:{item:(item,escape)=>'<div><span class="editable-text">'+escape(item.text)+"</span></div>",option:(item,escape)=>'<div class="padding-t5 padding-b5"><span class="editable-text">'+escape(item.text)+"</span></div>"},load:(query,callback)=>{if(query.length<min_chars)return callback();this._onItemSearch(query).then(callback)}}),_.extend(selectize_options,options),$input.data("prev-value",value).selectize(selectize_options),this.values.__selectize=$input[0].selectize}else is_wysiwyg?$input.summernote(_.extend({},options,{followingToolbar:!1,callbacks:{onInit:divs=>{this.values.__summernote=$input.data("summernote");let $editor=divs.editor,$controls=$('\n\t\t\t\t\t\t\t\t\t\t<div class="textarea-wysiwyg-controls">\n\t\t\t\t\t\t\t\t\t\t\t<a href="#" class="badge badge-primary control-item control-save"><i class="mdi mdi-check"></i></a>\n\t\t\t\t\t\t\t\t\t\t\t<a href="#" class="badge badge-primary control-item control-cancel"><i class="mdi mdi-close"></i></a>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t');$controls.find(".control-save").on("click",event=>{event.preventDefault();let value=this.values.__summernote.code();value.length&&!is_processing&&(this._onSave(value),is_processing=!0)}),$controls.find(".control-cancel").on("click",event=>{event.preventDefault(),this._onBeforeHide()._hide(),is_processing=!1}),$editor.append($controls)},onFocus:()=>{is_processing=!1,this.removeErrorTooltip()}}})):(is_type_radio||$input.on("focus.utils.editable",event=>{event.preventDefault(),is_processing=!1,this.removeErrorTooltip()}),this.isInlineTabbing()||is_contenteditable||$input.on("change.utils.editable",event=>{if(event.preventDefault(),event.stopPropagation(),!is_processing){let value=is_type_radio?$input.filter(":checked").val():$input.val();this._onSave(value),is_processing=!0}}),is_type_radio?$(document).on("click.utils.editable",event=>{/(^|\s)(editable-target|custom-control-label|popup-editable-field)(\s|$)/.test($(event.target).attr("class"))||(this._onBeforeHide(),this._hide())}):$input.on("blur.utils.editable",event=>{if(event.preventDefault(),event.stopPropagation(),!is_processing){let value=$input[is_contenteditable?"text":"val"]();this._onSave(value),is_processing=!0,this.removeErrorTooltip()}}));if(!is_contenteditable){$target.addClass("is-edited").after($cell.css({position:"absolute"}));let $target_parent=$target.parent();$target_parent.attr("class").match(/pos-fixed|pos-absolute|pos-relative/g)||/absolute|relative|fixed/i.test($target_parent.css("position"))||$target_parent.addClass("pos-relative");let pos=$target.position();/flex/i.test($target_parent.css("display"))&&(pos.left+=parseInt($target.css("margin-left"))),$cell.css({top:pos.top+$target.height(),left:pos.left,minWidth:250})}this._show(),is_selectize||is_multiselect_dropdown?$input[0].selectize.focus():is_wysiwyg?$input.summernote("focus"):is_type_radio?$input.filter(":checked").focus():$input.focus()}this.fns("onAfterActionTriggered")})}removeErrorTooltip(){let Hint=this.getInputField().data("utils.hint");return Hint&&Hint.clean(),this}enable(){if(!this.values.is_enabled){var $target=this.getTarget(),is_type_checkbox=this.isTypeCheckbox(),$cell=this.getCell();if($cell&&$cell.length)is_type_checkbox?this.getInputField().prop("disabled",!1):$target.hasClass("readonly")&&$target.removeClass("readonly");else{var toggle_action=this.getToggleAction(),is_lazyload=this.isLazyLoad();this.values._is_cell_created=this._createCell().then(()=>{is_type_checkbox||is_lazyload||$target.on(toggle_action,event=>{event.preventDefault(),/true/i.test($target.prop("contenteditable"))||this._onActionTriggered()})})}this.getSpinner().setTarget($cell),this.values.is_enabled=!0}return this}disable(){if(this.values.is_enabled){var $target=this.getTarget();this.isTypeCheckbox()?this.getInputField().prop("disabled",!0):$target.addClass("readonly"),this.values.is_enabled=!1}return this}getToggleAction(){return this.values.toggle_action}setToggleAction(toggle_action){return toggle_action&&(this.values.toggle_action=/\.utils\.editable$/.test(toggle_action)?toggle_action:toggle_action+".utils.editable"),this}getSpinner(){return this.values.__spinner}getFieldName(){return this.values.field_name}setFieldName(field_name){return field_name&&(this.values.field_name=field_name),this}isInlineTabbing(){return this.values.is_inline_tabbing}setInlineTabbing(state){return this.values.is_inline_tabbing=!!state,this}getDateFormat(){return this.values.date_format}setDateFormat(date_format){return date_format&&(this.values.date_format=date_format),this}setTarget(target){return super.setTarget(target),this.getTarget().addClass("editable-target"),this.getTarget().html().length||this.setDisplayValue(this.getPlaceholder()),this}getType(){return this.values.type}setType(type){if(type){let subtypes=type.split("-"),base=subtypes.shift(),option=subtypes.join("-");this.values.type={base:base,option:option},this.values.type.option&&/^wysiwyg/i.test(this.values.type.option)&&this.getTarget().addClass("editable-wysiwyg")}return this}isTypeDate(){return/^date/i.test(this.getType().base)}isDateRange(){return/range/i.test(this.getType().option)}isTypeCheckbox(){return/^checkbox/i.test(this.getType().base)}isTypeRadio(){return/^radio/i.test(this.getType().base)}isTypeInput(){return/^input/i.test(this.getType().base)}isTypeDropDown(){return/^select/i.test(this.getType().base)}isTypeTextarea(){return/^textarea/i.test(this.getType().base)}isSelectize(){return/selectize/i.test(this.getType().option)}isSummernote(){return null!==this.getSummernote()}isMultiSelect(){return/multiselect/i.test(this.getType().option)}isAutoComplete(){return/autocomplete/i.test(this.getType().option)}isWysiwyg(){return/^wysiwyg/i.test(this.getType().option)}getValue(){return _.clone(this.values.value)}setValue(value){return new Promise((resolve,reject)=>{if(this.values.value=value,this.isLazyLoad()){var $target=this.getTarget(),target_options=$target.data("editable-options");_.isPlainObject(target_options)&&$target.data("editable-options",_.extend(target_options,{value:value}))}this.setDisplayValue(value).then(resolve)})}setDisplayValue(value){return new Promise((resolve,reject)=>{var $target=this.getTarget();this.isTypeCheckbox()||$target.html(this.filterValueForDisplay(value)),resolve()})}getDisplayValue(){var $target=this.getTarget(),is_type_checkbox=this.isTypeCheckbox(),is_contenteditable=this.isContentEditable();return is_type_checkbox?this.getValue():is_contenteditable?$target.data("prev-value")||"":$target.text()}getParams(){return this.values.params}setParams(params={}){return this.values.params=params,this}_onCancel(){this._hide(),this.fns("onCancel")}getInputField(){return this.isContentEditable()?this.getTarget():this.values.$input}setInputField(input){return this.values.$input=$(input),this}getCell(){return this.values.$cell}getOptions(){return this.values.options}setOptions(options){return _.extend(this.values.options,options),this}_createCell(){return new Promise((resolve,reject)=>{var type=this.getType(),methods={input:"_createInput",textarea:"_createTextarea",select:"_createDropdown",date:"_createDate",checkbox:"_createCheckbox",radio:"_createRadio"};if(!(type.base in methods))throw new Error("incorrect @type specified!");this[methods[type.base]]().then($cell=>{this.values.$cell=$cell,this.fns("onInputCreate"),resolve()}).catch(error=>{throw new Error(error)})})}_show(){return this.values.is_shown||(this.fns("onShow"),this.values.is_shown=!0),this}_hide(){return this.values.is_shown&&(this.fns("onHide"),this.values.is_shown=!1),this}_createInput(){return new Promise((resolve,reject)=>{var display_value=this.getDisplayValue(),css=this.getCss(),$wrapper=$('<form class="form-inline editable-form" data-form-type="input"><div class="form-group '+css+'"><label class="sr-only">Enter Text</label></div></form>'),$input=$('<input type="text" class="form-control popup-editable-field" value="'+this.filterValueForEditing(display_value)+'">');$input.putCursorAtEnd("focus.utils.editable"),this.setInputField($input),$wrapper.find(".form-group").append($input),resolve($wrapper)})}_createTextarea(){return new Promise((resolve,reject)=>{var display_value=this.getDisplayValue(),css=this.getCss(),$wrapper=$('<form class="form-inline editable-form" data-form-type="textarea"><div class="form-group '+css+'"><label class="sr-only">Enter Text</label></div></form>'),$textarea=$('<textarea class="form-control popup-editable-field" rows="3">'+this.filterValueForEditing(display_value)+"</textarea>");this.setInputField($textarea),$wrapper.find(".form-group").append($textarea),resolve($wrapper)})}_createDropdown(){return new Promise((resolve,reject)=>{var is_multiselect=this.isMultiSelect(),css=this.getCss(),$wrapper=$('<form class="form-inline editable-form" data-form-type="dropdown"><div class="form-group '+css+'"><label class="sr-only">Select One</label></div></form>'),$dropdown=$('<select class="form-control popup-editable-field custom-select" '+(is_multiselect?'multiple="multiple"':"")+"></select>");this.setInputField($dropdown),$wrapper.find(".form-group").append($dropdown),resolve($wrapper)})}_createDate(){return new Promise((resolve,reject)=>{var $target=this.getTarget(),is_date_range=this.isDateRange(),display_value=this.getDisplayValue(),css=this.getCss(),options=this.getOptions(),$picker=null;if($target.data("date",display_value),is_date_range){if(_.extend(options,{target:$target,onApply:(DateRangePicker,options)=>{this._onSave(options.range)},onShown:(DateRangePicker,options)=>{DateRangePicker.getElm().addClass(css),this._show()}}),this.values.DateRangePicker=new UTILS.Daterange(options).enable(),display_value!==this.getPlaceholder()){let dates=_.map(display_value.split("-"),date=>date.trim());this.values.DateRangePicker.setDateRange(...dates)}$picker=this.values.DateRangePicker.getElm()}else $target.datepicker(options),this.values.DatePicker=$target.data("datepicker"),display_value!==this.getPlaceholder()&&$target.datepicker("setDate",moment(display_value,options.format).toDate()),$target.on("changeDate",event=>{this._onSave(moment(event.date).format(options.format))}).on("show",event=>{$target.data("datepicker").picker.addClass(css),this._show()}),$picker=this.values.DatePicker.picker;resolve($picker)})}_createCheckbox(){return new Promise((resolve,reject)=>{var $target=this.getTarget(),id=UTILS.uuid(),control_class=/switch/i.test(this.getType().option)?"custom-toggle my-2":"custom-checkbox mb-3",display_value=this.getDisplayValue(),css=this.getCss(),options=this.getOptions(),$wrapper=$('<form class="form-inline editable-form" data-form-type="checkbox"><div class="form-group '+css+'"><div class="custom-control '+control_class+'"><label class="custom-control-label" for="'+id+'">'+("desc"in options?options.desc:"")+"</label></div></div></form>"),$input=$('<input type="checkbox" id="'+id+'" class="custom-control-input popup-editable-field" value="'+display_value+'">');$input.prop("checked",/^(true|yes|ok)$/i.test(display_value)),this.setInputField($input),$wrapper.find(".custom-control").prepend($input),$input.on("change.utils.editable",function(event){event.preventDefault(),this._onSave($input.prop("checked"))}.bind(this)),$target.html($wrapper),resolve($wrapper)})}_createRadio(){return new Promise((resolve,reject)=>{var value=this.getValue(),name=UTILS.uuid(),css=this.getCss(),$wrapper=$('<form class="form-inline editable-form radio-type'+css+'" data-form-type="radio"></form>');$wrapper.append(_.map(this.getItems(),function(item){var id=UTILS.uuid();return`<div class="form-group row">\n\t\t\t\t\t\t\t\t<div class="custom-control custom-radio mb-1">\n\t\t\t\t\t\t\t\t\t<input type="radio" id="${id}" name="${name}" class="custom-control-input popup-editable-field" value="${item.value}">\n\t\t\t\t\t\t\t\t\t<label class="custom-control-label" for="${id}">${item.label}</label>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>`}.bind(this)));var $inputs=$wrapper.find('.custom-control-input[type="radio"]');this.setInputField($inputs),value&&value.length&&$inputs.filter('[value="'+value+'"]').prop("checked",!0),resolve($wrapper)})}_onBeforeHide(){var $input=this.getInputField(),$target=this.getTarget(),is_type_checkbox=this.isTypeCheckbox(),is_type_radio=this.isTypeRadio(),is_selectize=this.isSelectize(),is_multiselect_dropdown=this.isMultiSelect()&&this.isTypeDropDown(),is_wysiwyg=this.isWysiwyg(),is_date_range=this.isDateRange();return is_type_checkbox||is_date_range||($input&&(is_selectize||is_multiselect_dropdown?$input[0].selectize.destroy():is_wysiwyg?$input.summernote("destroy"):$input.off("keydown.utils.editable change.utils.editable blur.utils.editable focus.utils.editable"),is_type_radio&&$(document).off("click.utils.editable")),this.getCell().remove()),$target.removeClass("is-edited").prop("contenteditable",!1),this.getSpinner().hide(),this}getDatePicker(){return this.values.DatePicker}getDateRangePicker(){return this.values.DateRangePicker}getSelectize(){return this.values.__selectize}getSummernote(){return this.values.__summernote}__onSave__(value){return new Promise((resolve,reject)=>{let is_type_date=this.isTypeDate(),is_date_range=this.isDateRange(),is_type_checkbox=this.isTypeCheckbox(),is_multiselect=this.isMultiSelect(),is_autocomplete=this.isAutoComplete(),$target=this.getTarget(),$cell=this.getCell(),$editable=null,__spinner=this.getSpinner(),ajax_settings=this.getAjaxData(),params=this.getParams(),field_name=this.getFieldName(),is_contenteditable=this.isContentEditable(),DatePicker=this.getDatePicker(),DateRangePicker=this.getDateRangePicker();is_multiselect&&is_autocomplete&&(value=value.split(/,\s*/g).filter(str=>str.replace(/,/g,"").length).join(",")),$editable=is_type_date?is_date_range?DateRangePicker.getElm():DatePicker.picker:is_type_checkbox?$target.find(".custom-control"):is_autocomplete?$target.parent():$cell,__spinner.setTarget($editable);let _updateContentEditable=()=>{$target.prop("contenteditable",!1).html(this.filterValueForDisplay(value))};if(is_multiselect&&(()=>{let curr_values,prev_values,is_changed=!1;return this.isTypeDropDown()?(curr_values=_.map(value,item=>parseInt(item)),prev_values=_.map(this.getInputField().data("prev-value"),item=>parseInt(item)),is_changed=JSON.stringify(curr_values.sort())!==JSON.stringify(prev_values.sort())):(curr_values=value,prev_values=this.getDisplayValue(),is_changed=curr_values.replace(/[\s,]/g,"")!==prev_values.replace(/[\s,]/g,"")),is_changed})()||!is_multiselect&&this.getDisplayValue()!=this.filterValueForDisplay(value)){_log(this.getObjectName()+" --\x3e value changed, saving...");let _onError=error=>{__spinner.hide(),error instanceof Error&&UTILS.Errors.show(error.message),is_contenteditable&&_updateContentEditable(),this._onBeforeHide(),this._hide(),is_type_date&&(is_date_range?DateRangePicker.hide():DatePicker.hide()),this.fns("onSaveError",error),reject()},_onSuccess=response=>{__spinner.hide(),_.isString(response)&&(response=JSON.parse(response)),"errors"in response&&response.errors.length&&(response.direction="top",_.each(response.errors,error=>{"fields"in error&&!error.fields.length&&error.fields.push($target)})),UTILS.Errors.isError(response)||this.setValue(value).then(()=>{this._onBeforeHide(),$target.velocity("callout.flash"),this._hide(),is_type_date&&(is_date_range?DateRangePicker.hide():DatePicker.hide()),this.fns("onAfterSave",response),resolve()})};this.fns("onBeforeSave",value),__spinner.show();var _getFormatedParams=()=>{let data={};return params?data=_.assign({},_.isFunction(params)?params.call(null,value,this):{...params,[field_name]:value}):data[field_name]=is_type_checkbox?!!value:value,data};if(is_type_checkbox&&__spinner.getSpinner().css({left:15}),"url"in ajax_settings&&ajax_settings.url.length){let url=ajax_settings.url,options={method:"POST",data:_getFormatedParams()};"method"in ajax_settings&&(options.data.method=ajax_settings.method),"content_type"in ajax_settings&&(options.content_type=ajax_settings.content_type,/\/json$/.test(ajax_settings.content_type)&&(options.data=JSON.stringify(options.data))),$.fetch(url,options).then(_onSuccess).catch(_onError)}else _onSuccess({errors:[],..._getFormatedParams()})}else _log(this.getObjectName()+" --\x3e same value, no action taken"),is_contenteditable&&_updateContentEditable(),this._onBeforeHide(),this._hide(),this.fns("onNoChange"),resolve()})}};