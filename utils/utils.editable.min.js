UTILS.Editable=class extends UTILS.Base{constructor(data={}){return super(data),"type"in data&&(/^date/i.test(data.type)?this.values.options={container:this.getContainer(),orientation:"bottom",autoclose:!1,format:"MM/DD/YYYY",startDate:moment().add(1,"day").toDate(),todayHighlight:!0}:/^textarea\-wysiwyg/i.test(data.type)&&(this.values.options={toolbar:[["style",["bold","italic","underline","strikethrough","color","clear"]],["para",["ul","ol"]],["insert",["picture","link","table","hr"]],["code",["gxcode"]],["misc2",["print"]]]})),this._onSave=_.debounce(this.__onSave__.bind(this),500),"params"in data&&this.setParams(data.params),"field"in data&&this.setFieldName(data.field),"type"in data&&this.setType(data.type),"options"in data&&this.setOptions(data.options),"css"in data&&this.setCss(data.css),"filterMethodForEditingValue"in data&&this.setFilterMethodForEditingValue(data.filterMethodForEditingValue),"filterMethodForDisplayValue"in data&&this.setFilterMethodForDisplayValue(data.filterMethodForDisplayValue),"tabbing"in data&&this.setInlineTabbing(data.tabbing),"lazyload"in data&&this.setLazyLoadState(data.lazyload),"contenteditable"in data&&this.setContentEditableState(data.contenteditable),"toggle"in data&&this.setToggleAction(data.toggle),"items"in data&&this.setItems(data.items),"container"in data&&this.setContainer(data.container),"onShow"in data&&this.addCallback("onShow",data.onShow),"onHide"in data&&this.addCallback("onHide",data.onHide),"onCancel"in data&&this.addCallback("onCancel",data.onCancel),"onBeforeSave"in data&&this.addCallback("onBeforeSave",data.onBeforeSave),"onAfterSave"in data&&this.addCallback("onAfterSave",data.onAfterSave),"onSaveError"in data&&this.addCallback("onSaveError",data.onSaveError),"onActionTriggered"in data&&this.addCallback("onActionTriggered",data.onActionTriggered),"onAfterActionTriggered"in data&&this.addCallback("onAfterActionTriggered",data.onAfterActionTriggered),"onNoChange"in data&&this.addCallback("onNoChange",data.onNoChange),"onInputCreate"in data&&this.addCallback("onInputCreate",data.onInputCreate),"value"in data&&this.setValue(data.value),"placeholder"in data&&this.setPlaceholder(data.placeholder),this}getDefaults(){return{object:"utils.editable",version:"0.5.7",direction:"top",type:{base:"input",option:null},css:"",params:null,$cell:null,$input:null,$container:$("body"),value:null,DatePicker:null,options:{},field_name:"@field",placeholder:"--",is_lazyload:!1,toggle_action:"click",Spinner:new UTILS.Spinner({type:"small",center:!0,color:"black",blur:!0}),is_inline_tabbing:!1,items:[],is_enabled:!1,is_shown:!1,display_filtermethod:null,edit_filtermethod:null,is_contenteditable:!1,_is_cell_created:null}}getCss(){return this.values.css}setCss(css){this.values.css=css||""}setAjaxData(ajax){return _.isPlainObject(ajax)?super.setAjaxData(ajax):this.values.ajax=null===ajax?{}:ajax,this}getContainer(){return this.values.$container}setContainer(container){return this.values.$container=$(container),this}isLazyLoad(){return this.values.is_lazyload}setLazyLoadState(state){return this.values.is_lazyload=!!state,this}isContentEditable(){return this.values.is_contenteditable}setContentEditableState(state){return(this.isTypeInput()||this.isTypeTextarea())&&(this.values.is_contenteditable=!!state),this}getPlaceholder(value){return _.isFunction(this.values.placeholder)?this.values.placeholder(value,this):this.values.placeholder}setPlaceholder(placeholder){return placeholder&&(this.values.placeholder=placeholder),this}getItems(){return this.values.items}setItems(items){return _.isArray(items)&&(_.isString(items.first())&&(items=_.map(items,function(item){return{label:item,value:item}})),this.values.items=items),this}_filterValueForEditing(value){var _value=value;return"function"==typeof this.values.edit_filtermethod&&(_value=this.values.edit_filtermethod(value)),this.values.placeholder===_value&&(_value=""),_value}_filterValueForDisplay(value){var type=this.getType(),_value=value;if("function"==typeof this.values.display_filtermethod)_value=this.values.display_filtermethod(value);else if(/^(select|radio)$/.test(type.base)){var item=_.find(this.getItems(),function(item){return item.value==value});item&&(_value=item.label)}return _value.length||(_value=this.values.placeholder),_value}_onActionTriggered(){this.values._is_cell_created.then(()=>{var $target=this.getTarget(),$cell=this.getCell(),is_type_date=this.isTypeDate(),is_type_checkbox=this.isTypeCheckbox(),is_type_radio=this.isTypeRadio(),is_selectize=this.isSelectize(),is_wysiwyg=this.isWysiwyg(),is_type_textarea=this.isTypeTextarea(),is_contenteditable=this.isContentEditable(),$input=this.getInputField(),$next_editable=$target.nextNodeByClass("editable-target"),value=this.getValue(),options=this.getOptions(),is_processing=!1,keys={ENTER:13,ESCAPE:27,TAB:9},active_keys=[keys.ESCAPE];is_type_textarea||active_keys.push(keys.ENTER);var _triggerNextEditable=()=>{$next_editable.trigger(this.getToggleAction())};if(this.fns("onActionTriggered"),!is_type_date&&!is_type_checkbox){if(is_contenteditable){let prev_value=$input.text();$input.data("prev-value",prev_value).prop("contenteditable",!0).text(this._filterValueForEditing(prev_value)).putCursorAtEnd()}if($input.on("keydown.utils.editable",event=>{let value=$(event.currentTarget)[is_contenteditable?"text":"val"]();active_keys.isIn(UTILS.getCharKey(event))?(event.preventDefault(),this._onSave(value),is_processing=!0):[keys.TAB].isIn(UTILS.getCharKey(event))&&this.isInlineTabbing()&&(event.preventDefault(),is_processing=!0,$next_editable.length?this._onSave(value).then(_triggerNextEditable):this._onSave(value))}),is_type_radio?$input.val([value]):is_contenteditable||$input.val(value),is_selectize)$input.selectize({onFocus:()=>{is_processing=!1},onChange:()=>{let value=$input[0].selectize.getValue();value.length&&(this._onSave(value),is_processing=!0)},onBlur:()=>{var value=$input[0].selectize.getValue();value.length&&!is_processing&&(this._onSave(value),is_processing=!0)},selectOnTab:this.isInlineTabbing()});else if(is_wysiwyg){var self=this;$input.summernote(_.extend({},options,{followingToolbar:!1,callbacks:{onInit:function(divs){var summernote=$(this).data("summernote"),$editor=divs.editor,$controls=$('\n\t\t\t\t\t\t\t\t\t<div class="textarea-wysiwyg-controls">\n\t\t\t\t\t\t\t\t\t \t<a href="#" class="badge badge-primary control-item control-save"><i class="mdi mdi-check"></i></a>\n\t\t\t\t\t\t\t\t\t \t<a href="#" class="badge badge-primary control-item control-cancel"><i class="mdi mdi-close"></i></a>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t');$controls.find(".control-save").on("click",event=>{event.preventDefault();var value=summernote.code();value.length&&!is_processing&&(self._onSave(value),is_processing=!0)}),$controls.find(".control-cancel").on("click",event=>{event.preventDefault(),self._onBeforeHide()._hide(),is_processing=!1}),$editor.append($controls)},onFocus:()=>{is_processing=!1}}}))}else is_type_radio||$input.on("focus.utils.editable",event=>{event.preventDefault(),is_processing=!1}),this.isInlineTabbing()||is_contenteditable||$input.on("change.utils.editable",event=>{event.preventDefault(),event.stopPropagation(),is_processing||(this._onSave($(event.currentTarget).val()),is_processing=!0)}),is_type_radio?$(document).on("click.utils.editable",event=>{/(^|\s)(editable-target|custom-control-label|popup-editable-field)(\s|$)/.test($(event.target).attr("class"))||(this._onBeforeHide(),this._hide())}):$input.on("blur.utils.editable",event=>{if(event.preventDefault(),!is_processing){let value=$(event.currentTarget)[is_contenteditable?"text":"val"]();this._onSave(value),is_processing=!0}});if(!is_contenteditable){$target.addClass("is-edited").after($cell.css({position:"absolute"}));let $target_parent=$target.parent();$target_parent.attr("class").match(/pos-fixed|pos-absolute|pos-relative/g)||/absolute|relative|fixed/i.test($target_parent.css("position"))||$target_parent.addClass("pos-relative");let pos=$target.position();/flex/i.test($target_parent.css("display"))&&(pos.left+=parseInt($target.css("margin-left"))),$cell.css({top:pos.top+$target.height(),left:pos.left,minWidth:250})}this._show(),is_selectize?$input[0].selectize.focus():is_wysiwyg?$input.summernote("focus"):is_type_radio?$input.filter(":checked").focus():$input.focus()}this.fns("onAfterActionTriggered")})}enable(){if(_log("editable --\x3e enabled",this.getId()),!this.values.is_enabled){var $target=this.getTarget(),is_type_checkbox=this.isTypeCheckbox(),$cell=this.getCell();if($cell&&$cell.length)is_type_checkbox?this.getInputField().prop("disabled",!1):$target.hasClass("readonly")&&$target.removeClass("readonly");else{var toggle_action=this.getToggleAction(),is_lazyload=this.isLazyLoad();this.values._is_cell_created=this._createCell().then(()=>{is_type_checkbox||(is_lazyload||$target.on(toggle_action,event=>{event.preventDefault(),this._onActionTriggered()}),this.isContentEditable()&&$target.putCursorAtEnd("focus.utils.editable"))})}this.values.is_enabled=!0}return this}disable(){if(_log("editable --\x3e disabled",this.getId()),this.values.is_enabled){var $target=this.getTarget();this.isTypeCheckbox()?this.getInputField().prop("disabled",!0):$target.addClass("readonly"),this.values.is_enabled=!1}return this}getToggleAction(){return this.values.toggle_action}setToggleAction(toggle_action){return toggle_action&&(this.values.toggle_action=/\.utils\.editable$/.test(toggle_action)?toggle_action:toggle_action+".utils.editable"),this}getSpinner(){return this.values.Spinner}setFilterMethodForEditingValue(method){return"function"==typeof method&&(this.values.edit_filtermethod=method),this}setFilterMethodForDisplayValue(method){return"function"==typeof method&&(this.values.display_filtermethod=method),this}getFieldName(){return this.values.field_name}setFieldName(field_name){return field_name&&(this.values.field_name=field_name),this}isInlineTabbing(){return this.values.is_inline_tabbing}setInlineTabbing(state){return this.values.is_inline_tabbing=!!state,this}getDateFormat(){return this.values.date_format}setDateFormat(date_format){return date_format&&(this.values.date_format=date_format),this}setTarget(target){return super.setTarget(target),this.getTarget().addClass("editable-target"),this.getTarget().html().length||this._setDisplayValue(this.values.placeholder),this}getType(){return this.values.type}setType(type){return type&&(this.values.type={base:type.split("-")[0],option:type.split("-")[1]},this.values.type.option&&/^wysiwyg/i.test(this.values.type.option)&&this.getTarget().addClass("editable-wysiwyg")),this}isTypeDate(){return/^date$/i.test(this.getType().base)}isTypeCheckbox(){return/^checkbox/i.test(this.getType().base)}isTypeRadio(){return/^radio/i.test(this.getType().base)}isTypeInput(){return/^input/i.test(this.getType().base)}isTypeTextarea(){return/^textarea/i.test(this.getType().base)}isSelectize(){return/^selectize/i.test(this.getType().option)}isWysiwyg(){return/^wysiwyg/i.test(this.getType().option)}getValue(){return this.values.value}setValue(value){if(this.values.value=value,this.isLazyLoad()){var $target=this.getTarget(),target_options=$target.data("editable-options");_.isPlainObject(target_options)&&$target.data("editable-options",_.extend(target_options,{value:value}))}return this._setDisplayValue(value),this}_setDisplayValue(value){var $target=this.getTarget(),is_type_checkbox=this.isTypeCheckbox(),_value=is_type_checkbox?value:this._filterValueForDisplay(value);return is_type_checkbox||$target.html(_value),this}getDisplayValue(){var $target=this.getTarget(),is_type_checkbox=this.isTypeCheckbox(),is_contenteditable=this.isContentEditable();return is_type_checkbox?this.getValue():is_contenteditable?$target.data("prev-value"):$target.text()}getParams(){return this.values.params}setParams(params={}){return this.values.params=params,this}_onCancel(){_log(this.getObjectName()+" --\x3e action cancelled",this.getId()),this._hide(),this.fns("onCancel")}getInputField(){return this.isContentEditable()?this.getTarget():this.values.$input}setInputField(input){return this.values.$input=$(input),this}getCell(){return this.values.$cell}getOptions(){return this.values.options}setOptions(options){return _.extend(this.values.options,options),this}_createCell(){return new Promise((resolve,reject)=>{var type=this.getType(),methods={input:"_createInput",textarea:"_createTextarea",select:"_createDropdown",date:"_createDate",checkbox:"_createCheckbox",radio:"_createRadio"};if(!(type.base in methods))throw new Error("incorrect @type specified!");this[methods[type.base]]().then($cell=>{this.values.$cell=$cell,this.fns("onInputCreate"),_log(this.getObjectName()+" --\x3e "+JSON.stringify(type)+" cell created",this.values.$cell),resolve()}).catch(error=>{throw new Error(error)})})}_show(){return this.values.is_shown||(this.fns("onShow"),this.values.is_shown=!0),this}_hide(){return this.values.is_shown&&(this.fns("onHide"),this.values.is_shown=!1),this}_createInput(){return new Promise((resolve,reject)=>{var display_value=this.getDisplayValue(),css=this.getCss(),$wrapper=$('<form class="form-inline editable-form" data-form-type="input"><div class="form-group '+css+'"><label class="sr-only">Enter Text</label></div></form>'),$input=$('<input type="text" class="form-control popup-editable-field" value="'+this._filterValueForEditing(display_value)+'">');$input.putCursorAtEnd("focus.utils.editable"),this.setInputField($input),$wrapper.find(".form-group").append($input),resolve($wrapper)})}_createTextarea(){return new Promise((resolve,reject)=>{var display_value=this.getDisplayValue(),css=this.getCss(),$wrapper=$('<form class="form-inline editable-form" data-form-type="textarea"><div class="form-group '+css+'"><label class="sr-only">Enter Text</label></div></form>'),$textarea=$('<textarea class="form-control popup-editable-field" rows="3">'+this._filterValueForEditing(display_value)+"</textarea>");this.setInputField($textarea),$wrapper.find(".form-group").append($textarea),resolve($wrapper)})}_createDropdown(){return new Promise((resolve,reject)=>{var value=this.getValue(),css=this.getCss(),$wrapper=$('<form class="form-inline editable-form" data-form-type="dropdown"><div class="form-group '+css+'"><label class="sr-only">Select One</label></div></form>'),$dropdown=$('<select class="form-control popup-editable-field custom-select"></select>');this.setInputField($dropdown),$wrapper.find(".form-group").append($dropdown),$dropdown.append(_.map(this.getItems(),function(item){return $('<option value="'+item.value+'">'+item.label+"</option>")}.bind(this))),value&&value.length&&$dropdown.val(value),resolve($wrapper)})}_createDate(){return new Promise((resolve,reject)=>{var $target=this.getTarget(),display_value=this.getDisplayValue(),css=this.getCss(),options=this.getOptions();$target.data("date",display_value),$target.datepicker(options).on("changeDate",event=>{this._onSave(moment(event.date).format(options.format))}).on("show",event=>{$target.data("datepicker").picker.addClass(css),this._show()}),this.values.DatePicker=$target.data("datepicker"),display_value!==this.getPlaceholder()&&$target.datepicker("setDate",moment(display_value,options.format).toDate()),resolve(this.values.DatePicker.picker)})}_createCheckbox(){return new Promise((resolve,reject)=>{var $target=this.getTarget(),id=UTILS.uuid(),control_class=/switch/i.test(this.getType().option)?"custom-toggle my-2":"custom-checkbox mb-3",display_value=this.getDisplayValue(),css=this.getCss(),options=this.getOptions(),$wrapper=$('<form class="form-inline editable-form" data-form-type="checkbox"><div class="form-group '+css+'"><div class="custom-control '+control_class+'"><label class="custom-control-label" for="'+id+'">'+("desc"in options?options.desc:"")+"</label></div></div></form>"),$input=$('<input type="checkbox" id="'+id+'" class="custom-control-input popup-editable-field" value="'+display_value+'">');$input.prop("checked",/^(true|yes|ok)$/i.test(display_value)),this.setInputField($input),$wrapper.find(".custom-control").prepend($input),$input.on("change.utils.editable",function(event){event.preventDefault(),this._onSave($input.prop("checked"))}.bind(this)),$target.html($wrapper),resolve($wrapper)})}_createRadio(){return new Promise((resolve,reject)=>{var value=this.getValue(),name=UTILS.uuid(),css=this.getCss(),$wrapper=$('<form class="form-inline editable-form radio-type'+css+'" data-form-type="radio"></form>');$wrapper.append(_.map(this.getItems(),function(item){var id=UTILS.uuid();return`<div class="form-group row">\n\t\t\t\t\t\t\t\t<div class="custom-control custom-radio mb-1">\n\t\t\t\t\t\t\t\t\t<input type="radio" id="${id}" name="${name}" class="custom-control-input popup-editable-field" value="${item.value}">\n\t\t\t\t\t\t\t\t\t<label class="custom-control-label" for="${id}">${item.label}</label>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>`}.bind(this)));var $inputs=$wrapper.find('.custom-control-input[type="radio"]');this.setInputField($inputs),value&&value.length&&$inputs.filter('[value="'+value+'"]').prop("checked",!0),resolve($wrapper)})}_onBeforeHide(){var $input=this.getInputField(),is_type_checkbox=this.isTypeCheckbox(),is_type_radio=this.isTypeRadio();return is_type_checkbox||($input&&(this.isSelectize()?$input[0].selectize.destroy():this.isWysiwyg()?$input.summernote("destroy"):$input.off("keydown.utils.editable change.utils.editable blur.utils.editable focus.utils.editable"),is_type_radio&&$(document).off("click.utils.editable")),this.getCell().remove()),this.getTarget().removeClass("is-edited").prop("contenteditable",!1),this.getSpinner().hide(),this}__onSave__(value){return new Promise((resolve,reject)=>{var is_type_date=this.isTypeDate(),is_type_checkbox=this.isTypeCheckbox(),$target=this.getTarget(),$cell=this.getCell(),$editable=null,spinner=this.getSpinner(),ajax_settings=this.getAjaxData(),params=this.getParams(),field_name=this.getFieldName(),is_contenteditable=this.isContentEditable();$editable=is_type_date?this.values.DatePicker.picker:is_type_checkbox?$target.find(".custom-control"):$cell,spinner.setTarget($editable);let _updateContentEditable=()=>{$target.prop("contenteditable",!1).text(this._filterValueForDisplay(value))};if(this.getDisplayValue()!=this._filterValueForDisplay(value)){_log(this.getObjectName()+" --\x3e value changed, saving...",this.getId());let _onError=error=>{spinner.hide(),error instanceof Error&&UTILS.Errors.show(error.message),is_contenteditable&&_updateContentEditable(),this._onBeforeHide(),this._hide(),is_type_date&&this.values.DatePicker.hide(),this.fns("onSaveError",error),reject()},_onSuccess=response=>{spinner.hide(),_.isString(response)&&(response=JSON.parse(response)),response.direction="top",UTILS.Errors.isError(response)||(this.setValue(value),this._onBeforeHide(),$target.velocity("callout.flash"),this._hide(),is_type_date&&this.values.DatePicker.hide(),this.fns("onAfterSave",response),resolve())};this.fns("onBeforeSave",value),spinner.show();var _getFormatedParams=()=>{var data={};return params?data=_.assign({},_.isFunction(params)?params.call(null,value,this):{...params,[field_name]:value}):data[field_name]=is_type_checkbox?!!value:value,data};if(is_type_checkbox&&spinner.getSpinner().css({left:15}),"url"in ajax_settings&&ajax_settings.url.length){var url=ajax_settings.url,options={method:"POST",data:_getFormatedParams()};"method"in ajax_settings&&(options.data.method=ajax_settings.method),"content_type"in ajax_settings&&(options.content_type=ajax_settings.content_type,/\/json$/.test(ajax_settings.content_type)&&(options.data=JSON.stringify(options.data))),$.fetch(url,options).then(_onSuccess).catch(_onError)}else _onSuccess({errors:[],..._getFormatedParams()})}else _log(this.getObjectName()+" --\x3e same value, no action taken",this.getId()),is_contenteditable&&_updateContentEditable(),this._onBeforeHide(),this._hide(),this.fns("onNoChange"),resolve()})}};