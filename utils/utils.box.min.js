UTILS.Box=class extends UTILS.Base{constructor(data={}){super(data),"onCreate"in data&&this.addCallback("onCreate",data.onCreate),"onShow"in data&&this.addCallback("onShow",data.onShow),"onHide"in data&&this.addCallback("onHide",data.onHide),"onBlur"in data&&this.addCallback("onBlur",data.onBlur),"onUnblur"in data&&this.addCallback("onUnblur",data.onUnblur),"onStart"in data&&this.addCallback("onStart",data.onStart),"onBeforeStart"in data&&this.addCallback("onBeforeStart",data.onBeforeStart),"onComplete"in data&&this.addCallback("onComplete",data.onComplete),"onMaximize"in data&&this.addCallback("onMaximize",data.onMaximize),"onMinimize"in data&&this.addCallback("onMinimize",data.onMinimize),"onClose"in data&&this.addCallback("onClose",data.onClose),"onCancel"in data&&this.addCallback("onCancel",data.onCancel),"onBeforeClose"in data&&this.addCallback("onBeforeClose",data.onBeforeClose),"onCreate"in data&&this.addCallback("onCreate",data.onCreate),"onContentHeightChange"in data&&this.addCallback("onContentHeightChange",data.onContentHeightChange),"onContentUpdate"in data&&this.addCallback("onContentUpdate",data.onContentUpdate),"allow_close"in data&&this.setAllowCloseState(data.allow_close),this.values.max_responsive_width="w"in data&&data.w>768?data.w:768;var _data={w:data.w||600,h:data.h||"auto",html:data.html||"",light:!!data.light,title:data.title||"",controls:data.controls||"",classname:data.classname||"",buttons:data.buttons||null,coords:data.coords||null,center:!!data.center,offset:data.offset&&_.isPlainObject(data.offset)?data.offset:{left:0,top:0},freeze:!!data.freeze,blur:data.blur||null,dimmer:data.dimmer||!1,scrollable:data.scrollable||!1,resizeDims:data.resizeDims||null};return this._create().set(_data).enableResizeSensor(),this}getDefaults(){return{object:"utils.box",version:"3.3.7",history:{},is_shown:!1,$elm:null,divs:{scrolling_wrapper:null},html:"",num_of_opens:0,light:!1,fx:{effect:null,base:null},blur:{color:"black"},buttons:{close:!0,maximize:!1},resizeSensor:null,is_close_allowed:!0}}setTarget(target){return target&&(super.setTarget(target),target instanceof UTILS.Box&&(this.values.$target=target)),this}destroy(){this.values.$elm.remove()}clean(){return $(window).off("resize.utils.box resize.center.utils.box",this.onResize),$(document).off("keyup.escape.utils.box",this._onEscapeKeyPressed),this.fns("onBeforeClose"),this.cleanAfterMaximize(),null!=this.values.fx.effect?this.fx("close"):(this.destroy(),this.fns("onClose")),this}show(){this.values.num_of_opens++,1==this.values.num_of_opens&&this.fns("onBeforeStart");var _show=function(){null!=this.values.fx.effect&&1==this.values.num_of_opens?this.fx("open"):(this.values.$elm.show().css("visibility","visible"),1==this.values.num_of_opens&&(this.fns("onStart"),this.fns("onComplete")),this.fns("onShow")),this.values.is_shown=!0}.bind(this);if(this.values.scrollable&&this.enableScrolling(),this.values.dimmer){var onClose=new Function;if(this.isGlobalBox())onClose=this instanceof APP.Box&&APP.stack.getBoxes().length>1?new Function:UTILS.dim.hide,UTILS.dim.show(null,{onShow:_show});else if(this.values.$target instanceof UTILS.Box)onClose=this.values.$target.unblur.bind(this.values.$target),this.values.$target.blur(),_show(),this.getTargetDOM().append(this.values.$elm);else{var blur=new UTILS.Blur({target:this.values.$target,color:"black",onShow:_show});onClose=blur.hide.bind(blur),blur.show()}this.set({onClose:onClose},!0)}else _show();return this}hide(){return this.values.$elm.hide(),this.fns("onHide"),this.values.is_shown=!1,this}isShown(){return this.values.is_shown}isGlobalBox(){return!(this.values.$target instanceof UTILS.Box)&&this.values.$target.is("body")}isInsideBox(){return this.getParentBox().length}isMaximized(){return this.values.$elm.hasClass("maximized")}enableScrolling(){"scrollable"in this.values.history||this.isInsideBox()||this.isMaximized()||(this.values.history.scrollable={coords:this.values.coords,freeze:this.values.freeze,classes:this.values.$elm.attr("class").match(/(?:^|)pos-(\w+)(?!\w)/g)||[]},this.set({coords:{left:"auto",top:0},freeze:!1,onBeforeClose:this.disableScrolling.bind(this)},!0),this.values.divs.$scrolling_wrapper=this.values.$elm.wrap($("<div>",{class:"box-scrollable"})).parent(),this.values.$elm.removeClass("pos-fixed pos-absolute").addClass("cfx"),this.values.dimmer||$("body").addClass("overflow"))}disableScrolling(){"scrollable"in this.values.history&&(this.set({coords:this.values.history.scrollable.coords,freeze:this.values.history.scrollable.freeze,scrollable:!1},!0),this.values.divs.$scrolling_wrapper&&this.values.divs.$scrolling_wrapper.length&&this.values.divs.$scrolling_wrapper.after(this.values.$elm).remove(),this.values.dimmer||$("body").removeClass("overflow"),this.values.history.scrollable.classes.length&&(this.values.$elm.removeClass("pos-fixed pos-absolute"),this.values.$elm.addClass(_.joinArray(this.values.history.scrollable.classes," ")),this.values.center&&this.setCenter()),delete this.values.history.scrollable)}maximize(){switch(this.values.$elm.hasClass("maximized")){case!1:this.values.resizeDims?this.values.history.resizeDims=this.values.resizeDims:this.values.history.on_static={w:this.values.w,h:this.values.h,coords:this.values.$elm.offset()},this.set({resizeDims:0}),$("body").addClass("overflow"),this.values.divs.$maximize.attr({title:"minimize"}),this.values.$elm.addClass("maximized"),this.fns("onMaximize");break;case!0:"resizeDims"in this.values.history?(this.set({resizeDims:_.joinArray(this.values.history.resizeDims,"x")}),delete this.values.history.resizeDims):"on_static"in this.values.history&&(this.set({w:this.values.history.on_static.w,h:this.values.history.on_static.h,coords:this.values.history.on_static.coords}),delete this.values.history.on_static,this.values.resizeDims=null,$(window).off("resize.utils.box",this.onResize)),this.cleanAfterMaximize(),this.values.divs.$maximize.attr({title:"maximize"}),this.values.$elm.removeClass("maximized"),this.fns("onMinimize")}}cleanAfterMaximize(){1!=$(".box.maximized","body").length||$("body").hasClass("global-dimmer")||$("body").removeClass("overflow")}boxExists(){return!!$(this.values.$elm).length}blur(){var blur_instance=this.values.$elm.data("utils.blur");return blur_instance instanceof UTILS.Blur||(blur_instance=new UTILS.Blur({target:this.values.$elm})),blur_instance.set({color:this.values.blur.color,opac:this.values.blur.opac||null}).show(),this.fns("onBlur"),this}unblur(){var blur_instance=this.values.$elm.data("utils.blur");return blur_instance&&blur_instance.hide(),this.fns("onUnblur"),this}enableControls(){this.values.divs.$controls.show()}disableControls(){this.values.divs.$controls.hide()}empty(){var $mainbody=this.getMainbody(),$sensor=$mainbody.find(".resize-sensor");return $mainbody.empty(),$sensor.length&&$mainbody.append($sensor),this}onResize(){var $parent=this.isGlobalBox()?$(window):this.getTargetDOM(),page_w=$parent.width(),page_h=$parent.height(),dims={w:page_w-(this.values.resizeDims[1]+this.values.resizeDims[3]),h:page_h-(this.values.resizeDims[0]+this.values.resizeDims[2]),top:this.values.resizeDims[0],right:this.values.resizeDims[1],bottom:this.values.resizeDims[2],left:this.values.resizeDims[3]};this.values.center&&"responsive"in this.values.history&&(dims.h="auto",dims.w-=20,dims.left=this.isInsideBox()?20:"auto",this.enableScrolling()),this.set({w:dims.w,h:dims.h,coords:{top:dims.top,right:dims.right,bottom:dims.bottom,left:dims.left}})}setCenter(){return this.getBox().toggleClass("box-center",this.values.center),this.isGlobalBox()||this.getTargetDOM().toggleClass("box-center-support"),this}fx(action){action=action||"open";var cssFx=function(){this.values.$elm.offset();switch(action){case"open":this.values.$elm.velocity({"fade-up":"transition.slideUpIn","fade-down":"transition.slideDownIn","fade-left":"transition.slideLeftIn","fade-right":"transition.slideRightIn","slide-down":"transition.slideDownBigIn","slide-up":"transition.slideUpBigIn","slide-left":"transition.slideLeftBigIn","slide-right":"transition.slideRightBigIn",shake:"callout.shake","fade-in":"transition.fadeIn","fade-out":"transition.fadeOut","zoom-in":"transition.shrinkIn","zoom-out":"transition.shrinkOut","expand-in":"transition.expandIn","expand-out":"transition.expandOut","bounce-up":"transition.bounceUpIn","bounce-down":"transition.bounceDownIn","bounce-left":"transition.bounceLeftIn","bounce-right":"transition.bounceRightIn"}[this.values.fx.effect],{duration:500,begin:function(elms){this.values.$elm.show().css("visibility","visible"),this.fns("onStart",elms)}.bind(this),complete:function(elms){this.fns("onShow",elms),this.fns("onComplete",elms)}.bind(this)});break;case"close":this.values.$elm.velocity("reverse",{complete:function(elms){this.destroy(),this.fns("onClose")}.bind(this)})}}.bind(this),expand=function(){switch(action){case"open":if(this.values.fx.base.length){this.values.coords||this.set({center:!0},!0);var size={start:{w:this.values.fx.base.outerWidth(),h:this.values.fx.base.outerHeight()},end:{w:this.values.$elm.outerWidth(),h:this.values.$elm.outerHeight()}},coords={start:this.isGlobalBox()?this.values.fx.base.offset():this.values.fx.base.position(),end:this.isGlobalBox()?this.values.$elm.offset():this.values.$elm.position()};this.values.$elm.velocity({height:[size.end.h,size.start.h],width:[size.end.w,size.start.w],left:[coords.end.left,coords.start.left],top:[coords.end.top,coords.start.top],opacity:[1,.1]},{duration:400,begin:function(elm){this.values.divs.$outer.hide(),this.values.$elm.addClass("overflow"),this.values.$elm.show().css("visibility","visible"),this.fns("onStart",elm)}.bind(this),complete:function(elms){this.values.$elm.removeClass("overflow"),this.values.divs.$outer.show(),this.values.$elm.css({width:"auto",height:"auto"}),this.fns("onShow",elms),this.fns("onComplete",elms)}.bind(this)})}else UTILS.Errors.show("@base must be specified.");break;case"close":this.values.$elm.velocity("reverse",{begin:function(elms){this.values.divs.$outer.hide(),this.values.$elm.addClass("overflow")}.bind(this),complete:function(elms){this.destroy(),this.fns("onClose",elms)}.bind(this)})}}.bind(this);"expand"==this.values.fx.effect?expand():cssFx()}isCentered(){return this.values.center}enableResizeSensor(){return this.isCentered()&&!this.values.resizeSensor&&(this.values.resizeSensor=new ResizeSensor(this.getMainbody(),function(){this.fns("onContentHeightChange",{height:this.getMainbody().height()})}.bind(this))),this}disableResizeSensor(){return this.values.resizeSensor&&this.values.resizeSensor.detach(this.getMainbody()),this}getTargetDOM(){return this.values.$target instanceof UTILS.Box?this.values.$target.values.$elm:this.values.$target}getLastZIndex(){return parseInt($(".box").last().css("z-index"))+200||20001}_create(){let zindex=this.getLastZIndex(),box_id=this.getId(),$target=this.getTargetDOM();this.boxExists()&&this.values.$elm.remove();let $elm=$(`\n\t\t\t<div id="${box_id}" class="box ${this.isGlobalBox()?"pos-fixed":"pos-absolute"} ${this.values.light?"light":""}" data-box-allow-close="${this.isCloseAllowed()}">\n\t\t\t\t<div class="box-hd">\n\t\t\t\t\t<div class="box-hd-title"></div>\n\t\t\t\t\t<div class="box-top-buttons">\n\t\t\t\t\t\t<small class="box-timestamp text-muted"></small>\n\t\t\t\t\t\t<a href="#" title="maximize" class="box-top-buttons-maximize"><i class="mdi mdi-arrow-expand-all mdi-fw"></i></a>\n\t\t\t\t\t\t<a href="#" title="close" class="box-top-buttons-close"><i class="mdi mdi-close mdi-fw"></i></a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="box-outer">\n\t\t\t\t\t<div class="box-inner">\n\t\t\t\t\t\t<div class="box-mainbody"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="box-controls"></div>\n\t\t\t</div>\n\t\t`);return $elm.css("zIndex",zindex),this.values.divs.$hd=$elm.find(".box-hd"),this.values.divs.$title=$elm.find(".box-hd-title"),this.values.divs.$mainbody=$elm.find(".box-mainbody"),this.values.divs.$controls=$elm.find(".box-controls"),this.values.divs.$inner=$elm.find(".box-inner"),this.values.divs.$outer=$elm.find(".box-outer"),this.values.divs.$buttons=$elm.find(".box-top-buttons"),this.values.divs.$cls=$elm.find(".box-top-buttons-close"),this.values.divs.$maximize=$elm.find(".box-top-buttons-maximize"),this.values.divs.$timestamp=$elm.find(".box-timestamp"),this.values.$elm=$elm,$target.append(this.values.$elm),new MutationObserver(()=>{this.enableResizeSensor(),this.fns("onContentUpdate")}).observe(this.values.divs.$mainbody[0],{childList:!0,subtree:!0}),this.values.divs.$cls.on("click.clean.utils.box",event=>{event.preventDefault(),event.stopPropagation(),this.fns("onCancel"),this.clean("clean")}),this.values.divs.$maximize.on("click.maximize.utils.box",this.maximize.bind(this)),$(document).on("keyup.escape.utils.box",this._onEscapeKeyPressed.bind(this)),this.values.$elm.data(this.getObjectName().split(" v")[0],this),this.fns("onCreate"),this}getTimestamp(){return this.values.divs.$timestamp.html()}setTimestamp(time=""){return this.values.divs.$timestamp.html(time),this}_onEscapeKeyPressed(event){var key=UTILS.getCharKey(event),Box=$(".box").last().data("utils.box");27===key&&Box&&Box.getId()===this.getId()&&this.isCloseAllowed()&&this.clean()}isCloseAllowed(){return this.values.is_close_allowed}setAllowCloseState(state=!0){return this.values.is_close_allowed=state,this.values.$elm.attr("data-box-allow-close",state),this}set(data){if(data&&_.isPlainObject(data))for(var k in data)switch(!0){case/^target$/.test(k):var $target=this.getTarget();$(data[k]).get(0)!==$target.get(0)&&(this.setTarget(data[k]),this.getTargetDOM().append(this.values.$elm));break;case/^w$/.test(k):this.values.w=data[k],this.values.$elm.width(this.values.w);break;case/^h$/.test(k):this.values.h=data[k];let extra_h=this.values.divs.$controls.height();this.values.divs.$outer.height(_.isNumber(this.values.h)?this.values.h-extra_h:this.values.h);break;case/^title$/.test(k):this.values.title=data[k],this.values.title.length?this.values.divs.$title.html("<span>"+this.values.title+"</span>").show():this.values.divs.$title.hide();break;case/^html$/.test(k):let $mainbody=this.values.divs.$mainbody;this.values.html=data[k],$mainbody.velocity("fadeIn",{duration:500,begin:()=>{let $sensor=$mainbody.find(".resize-sensor");$mainbody.html(this.values.html),$sensor.length&&$mainbody.append($sensor)}});break;case/^controls$/.test(k):if(this.values.controls=data[k],this.values.divs.$controls.html(this.values.controls),this.values.divs.$controls.html().length){this.values.divs.$controls.addClass("expressed");var $close_btn=this.values.divs.$controls.find(".box-controls-close");$close_btn.length&&$close_btn.on("click.clean.utils.box",this.clean.bind(this))}else this.values.divs.$controls.removeClass("expressed"),this.values.divs.$mainbody.css({paddingBottom:0});break;case/^classname$/.test(k):this.values.classname=data[k],this.values.$elm.addClass(this.values.classname);break;case/^buttons$/.test(k):for(var button in _.isPlainObject(data[k])&&_.extend(this.values.buttons,data[k]),this.values.buttons)switch(button){case"close":this.setAllowCloseState(this.values.buttons.close);break;case"maximize":this.values.buttons.maximize?this.values.divs.$maximize.removeClass("hide"):this.values.divs.$maximize.addClass("hide")}break;case/^coords$/.test(k):this.values.coords=data[k],this.values.coords?this.values.$elm.css(this.values.coords):this.values.coords=null;break;case/^freeze$/.test(k):this.values.freeze=data[k],this.values.freeze?this.set({h:this.values.divs.$outer.outerHeight()+20}):this.set({h:"auto"});break;case/^center$/.test(k):this.values.center=data[k],this.setCenter();break;case/^blur$/.test(k):_.isPlainObject(data[k])&&(this.values.blur=_.extend(this.values.blur,data[k]));break;case/^dimmer$/.test(k):this.values.dimmer=!!data[k];break;case/^scrollable$/.test(k):this.values.scrollable=!!data[k];break;case/^onClose|onBeforeClose|onComplete|onShow|onStart|onBeforeStart|onHide|onMaximize|onMinimize|onBlur|onUnblur|onContentUpdate|onCancel$/.test(k):this.addCallback(k,data[k]);break;case/^resizeDims$/.test(k):if(this.values.resizeDims=data[k],$(window).off("resize.utils.box",this.onResize),this.values.resizeDims){if($(window).on("resize.utils.box",this.onResize.bind(this)),_.isNumber(this.values.resizeDims))tmp=[this.values.resizeDims,this.values.resizeDims,this.values.resizeDims,this.values.resizeDims];else var tmp=this.values.resizeDims.split("x");this.values.resizeDims=[];for(var i=0;i<tmp.length;i++)this.values.resizeDims.push(parseInt(tmp[i]));this.getBox().toggleClass("box-resize-dims",!!this.values.resizeDims),this.onResize()}}return this}getBox(){return this.values.$elm}getControls(){return this.values.divs.$controls}getMainbody(){return this.values.divs.$mainbody}getOuter(){return this.values.divs.$outer}getParentBox(){return this.values.$elm.parent().closest(".box")}};