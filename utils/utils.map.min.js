if(!GMAP)var GMAP=ART.Class({values:{},init:function(data){return this.values={},this.values.id="gmap-"+ART.str.uuid(),this.values.map_icon_default="images/icons/gmap-marker.png",this.values.is_shown=!1,this.values.fns={onEnable:[],onDisable:[],onShow:[],onHide:[],on_marker_show:[]},this.values.gmap={config:{styles:{},settings:{}},plugins:{maps:{plugin:"maps",ver:"3",options:{other_params:"sensor=false"},is_loaded:!1}}},this.values.marker={is_created:!1},this.set({target:data.target||null,styles:data.styles||this.defaults("styles"),settings:_.isPlainObject(data.settings)?_.extend(this.defaults("settings"),data.settings):this.defaults("settings"),is_static:"is_static"in data&&data.is_static,marker:_.isPlainObject(data.marker)?_.extend(this.defaults("marker"),data.marker):this.defaults("marker"),title:data.title||null,address:data.address||null,contact:data.contact||null,type:data.type||"roadmap",latlong:_.isPlainObject(data.latlong)?data.latlong:{lat:0,long:0},map_icon:data.map_icon||null,onEnable:data.onEnable||null,onDisable:data.onDisable||null,onShow:data.onShow||null,onHide:data.onHide||null}),this},defaults:function(config){return function(config){var data=null;switch(config){case"styles":data=[{featureType:"landscape",stylers:[{gamma:.8},{visibility:"simplified"},{color:"#938080"},{saturation:-100},{lightness:51}]},{featureType:"road.local",stylers:[{saturation:-100},{lightness:-13},{visibility:"on"}]},{featureType:"road.highway",stylers:[{gamma:1.39},{saturation:3},{lightness:-10},{visibility:"on"}]},{featureType:"road.arterial",stylers:[{gamma:.86},{lightness:14},{visibility:"on"},{saturation:-25}]},{featureType:"water",stylers:[{lightness:-11},{saturation:-35}]},{featureType:"poi",stylers:[{visibility:"on"},{saturation:-100},{lightness:-24},{gamma:.88}]},{featureType:"poi"}];break;case"settings":data={zoom:16,scrollwheel:!0,scaleControl:!1,disableDefaultUI:!1,panControl:!0,zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,draggable:!0,disableDoubleClickZoom:!0,scrollwheel:!0};break;case"marker":data={elm:ART.DIV({id:"gmap-marker-"+this.values.id,class:"gmap-marker"}),content:ART.DIV({class:"gmap-content"}),img:ART.IMG(),header:ART.H2({class:"gmap-marker-header"}),body:ART.DIV({class:"gmap-marker-body"}),shadow:ART.DIV({class:"gmap-shadow"}),is_special_marker:!1,contact:{img:("base_path"in MAIN.values?MAIN.values.base_path:"/")+"images/icons/gmap-marker-340x160.jpg"}}}return data}.bind(this)(config)},clean:function(){return ART.RE(this.values.elm),this},fns:function(type){if(type&&this.values.fns[type].length)for(var fn,i=0;fn=this.values.fns[type][i];i++)fn(this);return this},error:function(error){ERRORS.show(error||"unknown error has occurred.")},requiredToLoad:function(){var allow=!0,msgs=[];return this.values.target||msgs.push("@target must be specified"),this.values.address.length||msgs.push("@address must be specified"),msgs.length&&(allow=!1,this.error(msgs.join("\n\n"))),allow},show:function(){return this.requiredToLoad()&&this.loadPlugin("maps",function(){var options=this.values.gmap.config.settings;options.mapTypeId=google.maps.MapTypeId[{roadmap:"ROADMAP",satellite:"SATELLITE",hybrid:"HYBRID",terrain:"TERRAIN"}[this.values.type]],options.styles=this.values.gmap.config.styles,options.center=new google.maps.LatLng(this.values.latlong.lat,this.values.latlong.long);var map=new google.maps.Map(this.values.target,options);(new google.maps.Geocoder).geocode({address:this.values.address},function(results,status){if(status==google.maps.GeocoderStatus.OK){var loc=results[0].geometry.location;if(this.values.marker.is_special_marker)var coords=new google.maps.LatLng(loc.lat()-7e-4,loc.lng()+.0035);else coords=new google.maps.LatLng(loc.lat(),loc.lng());map.setCenter(coords);var data={map:map,position:loc,title:this.values.title,disableAutoPan:!0};this.values.map_icon?data.icon=this.values.map_icon:(data.icon=("base_path"in MAIN.values?MAIN.values.base_path:"/")+this.values.map_icon_default,this.values.marker.is_special_marker&&(data.position=new google.maps.LatLng(loc.lat()+5e-6,loc.lng()+1e-5)));var marker=new google.maps.Marker(data),content=this.markerRender(),info_window=new google.maps.InfoWindow({content:content,maxWidth:340});this.values.marker.is_special_marker?marker.setMap(map):google.maps.event.addListener(marker,"click",function(event){info_window.open(map,marker),this.fns("on_marker_show")}.bind(this)),google.maps.event.addListener(marker,"click",function(event){console.log(event)}.bind(this))}}.bind(this)),this.values.is_shown=!0,this.fns("onShow")}.bind(this)),this},hide:function(){return this.fns("onHide"),this},markerFormatContent:function(content,type,_class){var html=null;if(content&&type)switch(type){case"phone":html='<span class="phone">'+ART.format.phone(content)+"</span>";break;case"fax":html='<span class="fax">'+ART.format.phone(content)+"</span>";break;case"email":var email=content.split("").reverse().join("");html='<span class="email"><a class="bg-none text-reverse" href="#" onclick="COMMON.email(\''+email+"','Please get in touch');return false;\">"+email+"</a></span>";break;case"address":html='<span class="addr">'+content.replace(/(,){1}/,'</span><span class="addr">')+"</span>";break;case"sn":html='<span><a href="'+content+'" class="sn zocial '+_class+' blue" target="_blank"><i></i>'+ART.format.capitalize(_class,"all")+"</a></span>";break;case"directions":html='<span><a href="http://maps.google.com/maps?q='+ART.format.urlEncode(content)+'" class="sn iconsweets marker blue" target="_blank"><i></i>Get Directions</a></span>'}return html},markerCreate:function(){return this.values.marker.is_created||(ART.ACN(this.values.target,ART.ACN(this.values.marker.elm,ART.ACN(this.values.marker.content,this.values.marker.img,this.values.marker.header,this.values.marker.body),this.values.marker.shadow)),this.values.marker.is_created=!0),this},markerGetContent:function(){var html="";if(html+='<table class="gmap-marker-content">',html+="<tr>",html+="<td>",html+='<ul class="address">',html+="<li>",html+=this.markerFormatContent(this.values.address,"address"),"email"in this.values.marker.contact&&(html+=this.markerFormatContent(this.values.marker.contact.email,"email")),html+="</li>",html+="</ul>",html+="</td>",html+="<td>",html+='<ul class="address">',html+="<li>","phone"in this.values.marker.contact&&(html+=this.markerFormatContent(this.values.marker.contact.phone,"phone")),"socialnetworks"in this.values.marker.contact&&this.values.marker.contact.socialnetworks.length)for(var i=0;i<2;i++){var sn=this.values.marker.contact.socialnetworks[i];html+=this.markerFormatContent(sn.url,"sn",sn.class)}return html+=this.markerFormatContent(this.values.address,"directions"),html+="</li>",html+="</ul>",html+="</td>",html+="</tr>",html+="</table>"},markerRender:function(){var marker=null;return this.values.marker.is_special_marker?(!this.values.marker.is_created&&this.markerCreate(),this.values.marker.header.html(this.values.title),this.values.marker.body.html(this.markerGetContent()),marker=this.values.marker.elm):marker=(this.values.title.length?this.values.title+"<br>":"")+this.values.address,marker},loadPlugin:function(plugin,callback){var _plugin=this.getPlugin(plugin),_callback=function(){_plugin&&!_plugin.is_loaded&&(_plugin.is_loaded=!0),_.isFunction(callback)&&callback.call(this)}.bind(this);return _plugin&&!_plugin.is_loaded?google.load(_plugin.plugin,_plugin.ver,_.extend(_plugin.options,{callback:_callback})):_callback(),this},resetPlugin:function(plugin,callback){var _plugin=this.getPlugin(plugin);return _plugin&&(_plugin.is_loaded=!1,this.loadPlugin(_plugin,callback)),this},getPlugin:function(plugin){return _.isString(plugin)?this.values.gmap.plugins[plugin]:plugin},isPluginLoaded:function(plugin){var _plugin=this.getPlugin(plugin);return!!_plugin&&_plugin.is_loaded},set:function(data){if(data)for(var k in data)switch(k){case"target":this.values.target=data[k]instanceof BOX?data[k].values.elm:data[k];break;case"styles":_.isArray(data[k])&&(this.values.gmap.config.styles=data[k]);break;case"settings":_.isPlainObject(data[k])&&_.extend(this.values.gmap.config.settings,data[k]);break;case"type":this.values.type=data[k];break;case"marker":if(_.isPlainObject(data[k])){_.extend(this.values.marker,data[k]);var contact=this.defaults("marker").contact;for(var k in contact)!(k in this.values.marker.contact)&&(this.values.marker.contact[k]=contact[k]);this.values.marker.img.src=this.values.marker.contact.img,this.values.marker.is_special_marker?this.set({is_static:!0}):this.set({is_static:!1})}break;case"is_static":this.values.is_static=!!data[k];var settings={panControl:!0,zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,draggable:!0,disableDoubleClickZoom:!0,scrollwheel:!0};if(this.values.is_static)for(var k in settings)settings[k]=!1;this.set({settings:settings});break;case"onShow":case"onHide":case"on_marker_show":if(data[k]&&_.isFunction(data[k])){for(var fn,is_unique=!0,i=0;fn=this.values.fns[k][i];i++)if(data[k]===fn){is_unique=!1;break}is_unique&&this.values.fns[k].push(data[k])}break;default:this.values[k]=data[k]}return this}});